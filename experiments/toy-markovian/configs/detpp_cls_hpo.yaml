defaults:
  - default
  - default_rnn
  - _self_

name: detpp_cls_hpo

detection_k: 8

conditional_head:
  k: ${detection_k}

module:
  _target_: pretpp.modules.HPOModule
  hpo_losses:
    - loss_0__presence
    - loss_0_timestamps
    - loss_0_labels
  downstream_loss: loss_1_target
  loss_projection_partial:
    _target_: pretpp.nn.CatHead
    _partial_: true
    infer_output_size_index: 0
    head_partials:
      - ${conditional_head}
      - _target_: hotpp.nn.Head
        _partial_: true
        output_size: ${num_downstream_classes}
        hidden_dims: [128]
        use_batch_norm: true
  loss:
    _target_: pretpp.losses.HybridLoss
    prediction_loss: 1
    losses:
      - _target_: pretpp.losses.DeTPPLoss
        next_item_loss:
          _target_: hotpp.losses.NextItemLoss
          losses:
            _presence:
              _target_: hotpp.losses.BinaryCrossEntropyLoss
            timestamps:
              _target_: hotpp.losses.TimeMAELoss
              delta: start
              max_delta: ${max_duration}
            labels:
              _target_: hotpp.losses.CrossEntropyLoss
              num_classes: ${num_classes}
        k: ${detection_k}
        horizon: 8
        loss_subset: 0.25
        prefetch_factor: 1
        match_weights:
          _presence: 8
          timestamps: 1
          labels: 1
      - _target_: pretpp.losses.ClassificationLoss
        targets:
          target:
            num_classes: ${num_downstream_classes}
            cast: true
    aggregator:
      _target_: hotpp.nn.LastAggregator
