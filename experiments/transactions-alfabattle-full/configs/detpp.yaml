defaults:
  - default
  - default_rnn
  - _self_

name: detection

detection_k: 64

conditional_head:
  k: ${detection_k}

data_module:
  batch_size: 32

module:
  _target_: pretpp.modules.BaseModule
  loss_projection_partial: ${conditional_head}
  loss:
    _target_: pretpp.losses.DeTPPLoss
    k: ${detection_k}
    horizon: 7  # week.
    loss_subset: 0.25
    prefetch_factor: 1
    categorical_fields:
      - labels
      - currency
      - operation_kind
#      - card_type
      - operation_type
      - operation_type_group
      - ecommerce_flag
      - payment_system
      - income_flag
#      - country
#      - city
      - mcc_category
      - day_of_week
      - hour
      - weekofyear
    next_item_adapter:
      timestamps: mode
      labels: mode
      currency: mode
      operation_kind: mode
#      card_type: mode
      operation_type: mode
      operation_type_group: mode
      ecommerce_flag: mode
      payment_system: mode
      income_flag: mode
#      country: mode
#      city: mode
      mcc_category: mode
      day_of_week: mode
      hour: mode
      weekofyear: mode
      log_amount: mean
      log_hour_diff: mean
    match_weights:
      _presence: 3
      timestamps: 0.35
      labels: 1.0
      currency: 0.2
      operation_kind: 0.2
#      card_type: 0.2
      operation_type: 0.2
      operation_type_group: 0.2
      ecommerce_flag: 0.2
      payment_system: 0.2
      income_flag: 0.2
#      country: 0.2
#      city: 0.2
      mcc_category: 0.2
      day_of_week: 0.2
      hour: 0.2
      weekofyear: 0.2
      log_amount: 0.4
      log_hour_diff: 0.2
    next_item_loss:
      _target_: hotpp.losses.NextItemLoss
      losses:
        _presence:
          _target_: hotpp.losses.BinaryCrossEntropyLoss
          grad_scale: null
        timestamps:
          _target_: hotpp.losses.TimeMAELoss
          delta: start
          max_delta: ${max_duration}
          smoothing: 1
          grad_scale: null
        labels:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: ${num_classes}
        currency:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: 13
          grad_scale: null
        operation_kind:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: 9
          grad_scale: null
#        card_type:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 177
#          grad_scale: null
#        operation_type:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 24
#          grad_scale: null
        operation_type_group:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: 6
          grad_scale: null
#        ecommerce_flag:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 5
#          grad_scale: null
#        payment_system:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 9
#          grad_scale: null
        income_flag:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: 5
          grad_scale: null
#        country:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 26
#          grad_scale: null
#        city:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 170
#          grad_scale: null
        mcc_category:
          _target_: hotpp.losses.CrossEntropyLoss
          num_classes: 30
          grad_scale: null
#        day_of_week:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 9
#          grad_scale: null
#        hour:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 25
#          grad_scale: null
#        weekofyear:
#          _target_: hotpp.losses.CrossEntropyLoss
#          num_classes: 55
#          grad_scale: null
        log_amount:
          _target_: hotpp.losses.MAELoss
          grad_scale: null
#        log_hour_diff:
#          _target_: hotpp.losses.MAELoss
#          grad_scale: null
