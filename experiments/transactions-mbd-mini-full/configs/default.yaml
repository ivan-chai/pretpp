seed_everything: 42
num_evaluation_seeds: 3

num_classes: 55
num_classes_plus1: 56
max_time_delta: 8
max_duration: 8
num_downstream_classes: 2

rnn_hidden_size: 1024
rnn_half_hidden_size: 512
rnn_inference_context: 1200
rnn_inference_context_step: 200
rnn_min_length: 256

transformer_hidden_size: 512
transformer_inter_size: 1024
transformer_heads: 4
transformer_layers: 8
transformer_context: 300
transformer_positions: 2000
transformer_dropout: 0.1
transformer_min_length: 4
transformer_cls_token:
  timestamps: -1
  currency: 0
  event_subtype: 0
  src_type11: 0
  src_type12: 0
  dst_type11: 0
  dst_type12: 0
  src_type21: 0
  src_type22: 0
  src_type31: 0
  src_type32: 0
  log_amount: -1
transformer_history_token_frequency: 0.3
transformer_history_token_probability: 0.5
transformer_recmem_chunk_size: 256

logger:
  _target_: pytorch_lightning.loggers.WandbLogger
  project: pretpp-mbd-mini-full
  name: ${name}
  save_dir: lightning_logs
model_path: checkpoints/${name}.ckpt
report: results/${name}.yaml
multiseed_report: results/multiseed_${name}.yaml

data_module:
  _target_: hotpp.data.HotppDataModule
  rename:
    event_type: labels
  fields:
    - timestamps
    - log_amount
    - event_subtype
    - labels
    - currency
    - src_type11
    - src_type12
    - dst_type11
    - dst_type12
    - src_type21
    - src_type22
    - src_type31
    - src_type32
  batch_size: 512
  num_workers: 4
  local_targets_fields:
    - months_target_2
  local_targets_indices_field: months_last_id
  id_field: client_id
  train_params:
    random_split: 0.95
    random_part: train
    min_required_length: 2
    max_length: 600
    mbd: true
  val_params:
    random_split: 0.95
    random_part: val
    max_length: 300
    position: last
    mbd: true
  test_params:
    max_length: 600
    position: last
    mbd: true
  train_path: data/train.parquet
  val_path: data/train.parquet
  test_path: data/test.parquet

metric: null

nohead:
  _target_: pretpp.nn.IdentityHead
  _partial_: true

head:
  _target_: hotpp.nn.Head
  _partial_: true
  hidden_dims: [128]
  use_batch_norm: true

metric_head:
  _target_: pretpp.nn.MetricHead
  _partial_: true
  hidden_dims: [128]
  head_params:
    use_batch_norm: true

conditional_head:
  _target_: hotpp.nn.ConditionalHead
  _partial_: true
  hidden_dims: [128]
  use_batch_norm: true

metric_conditional_head:
  _target_: pretpp.nn.MetricConditionalHead
  _partial_: true
  hidden_dims: [128, 128]
  head_params:
    use_batch_norm: true

module:
  seq_encoder:
    embedder:
      _target_: hotpp.nn.Embedder
      use_batch_norm: false
      embeddings:
        labels:  # mcc.
          in: ${num_classes}
          out: 24
        event_subtype:
          in: 62
          out: 24
        currency:
          in: 17
          out: 4
        src_type11:
          in: 77
          out: 24
        src_type12:
          in: 526
          out: 24
        dst_type11:
          in: 133
          out: 24
        dst_type12:
          in: 821
          out: 12
        src_type21:
          in: 10002
          out: 64
        src_type22:
          in: 88
          out: 24
        src_type31:
          in: 2495
          out: 32
        src_type32:
          in: 88
          out: 24
      numeric_values:
        timestamps: identity
        log_amount: identity
    max_time_delta: ${max_time_delta}
  aggregator:
    _target_: hotpp.nn.LastAggregator
  optimizer_partial:
    _partial_: true
    _target_: torch.optim.Adam
    lr: 0.001
    weight_decay: 0.0
  lr_scheduler_partial:
    _partial_: true
    _target_: torch.optim.lr_scheduler.StepLR
    step_size: 10
    gamma: 0.8
  downstream_validation_config: configs/downstream.yaml
  val_metric: ${metric}
  test_metric: ${metric}

trainer:
  accelerator: cuda
  devices: 1
  max_epochs: 900
  enable_checkpointing: true
  precision: bf16-mixed
  gradient_clip_val: 1  # Increases training stability.
  check_val_every_n_epoch: 3
  model_selection:
    metric: val/accuracy-months_target_2
    mode: max
