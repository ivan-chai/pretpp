seed_everything: 42
num_evaluation_seeds: 5

num_classes: 10002
num_classes_plus1: 10003
max_time_delta: 14
max_duration: 120
num_downstream_classes: 2

rnn_hidden_size: 1280
rnn_half_hidden_size: 128
rnn_inference_context: 1024
rnn_inference_context_step: 256
rnn_min_length: 1

transformer_hidden_size: 512
transformer_inter_size: 1024
transformer_heads: 4
transformer_layers: 4
transformer_context: 1024
transformer_positions: 2500
transformer_dropout: 0.1
transformer_min_length: 1
transformer_cls_token:
  timestamps: -1
  labels: ${num_classes}  # Use final label for CLS.
  regular_points_received: 0
  express_points_received: 0
  regular_points_spent: 0
  express_points_spent: 0
  purchase_sum: 0
  product_quantity: 0
  trn_sum_from_iss: 0
  trn_sum_from_red: 0
  store_id: 0
  level_1: 0
  level_2: 0
  level_3: 0
  level_4: 0
  segment_id: 0
  brand_id: 0
  vendor_id: 0
  is_own_trademark: 0
  is_alcohol: 0
  netto: 0
transformer_history_token_frequency: 0.02
transformer_history_token_probability: 0.5

logger:
  _target_: pytorch_lightning.loggers.WandbLogger
  project: pretpp-retailhero
  name: ${name}
  save_dir: lightning_logs
model_path: checkpoints/${name}.ckpt
report: results/${name}.yaml
multiseed_report: results/multiseed_${name}.yaml

data_module:
  _target_: hotpp.data.HotppDataModule
  fields:
    - timestamps
    - labels
    - regular_points_received
    - express_points_received
    - regular_points_spent
    - express_points_spent
    - purchase_sum
    - product_quantity
    - trn_sum_from_iss
    - trn_sum_from_red
    - store_id
    - level_1
    - level_2
    - level_3
    - level_4
    - segment_id
    - brand_id
    - vendor_id
    - is_own_trademark
    - is_alcohol
    - netto
    - treatment
  batch_size: 512
  num_workers: 4
  train_params:
    min_required_length: 4
    max_length: 512
  val_params:
    max_length: 512
    position: last
  test_params:
    max_length: 512
    position: last
  global_target_fields: target
  train_path: data/train.parquet
  val_path: data/val.parquet
  test_path: data/test.parquet

metric: null

nohead:
  _target_: pretpp.nn.IdentityHead
  _partial_: true

head:
  _target_: hotpp.nn.Head
  _partial_: true
  hidden_dims: []
  use_batch_norm: true

metric_head:
  _target_: pretpp.nn.MetricHead
  _partial_: true
  hidden_dims: [256]
  head_params:
    use_batch_norm: true

conditional_head:
  _target_: hotpp.nn.ConditionalHead
  _partial_: true
  hidden_dims: [256]
  use_batch_norm: true

metric_conditional_head:
  _target_: pretpp.nn.MetricConditionalHead
  _partial_: true
  hidden_dims: [256, 128]
  head_params:
    use_batch_norm: true

module:
  seq_encoder:
    embedder:
      _target_: hotpp.nn.Embedder
      embeddings:
        labels:  # dummy.
          in: 1
          out: 0
        level_3:
          in: 203
          out: 16
        level_4:
          in: 790
          out: 16
        segment_id:
          in: 118
          out: 16
      numeric_values:
        timestamps: identity
        trn_sum_from_iss: identity
        netto: identity
        regular_points_received: identity
    max_time_delta: ${max_time_delta}
  aggregator:
    _target_: hotpp.nn.LastAggregator
  optimizer_partial:
    _partial_: true
    _target_: torch.optim.Adam
    lr: 0.001
    weight_decay: 0.0
  lr_scheduler_partial:
    _partial_: true
    _target_: torch.optim.lr_scheduler.StepLR
    step_size: 5
    gamma: 0.8
  val_metric: ${metric}
  test_metric: ${metric}
  downstream_validation_config: configs/downstream.yaml

trainer:
  accelerator: cuda
  devices: 1
  max_epochs: 30
  enable_checkpointing: true
  precision: 16-mixed
  gradient_clip_val: 1  # Increases training stability.
  check_val_every_n_epoch: 5
  model_selection:
    metric: val/downstream
    mode: max
  deterministic: true
